<!DOCTYPE html><html lang="zh-TW"><head><meta name="x-poe-datastore-behavior" content="local_only"><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>é«˜ç²¾åº¦è·³ç¹©è¨ˆæ•¸å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0c0c1e 0%, #1a1a3e 50%, #0d1f3c 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 15px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            text-align: center;
            padding: 15px 0;
        }

        h1 {
            font-size: 1.6rem;
            background: linear-gradient(90deg, #00f5d4, #00bbf9, #9b5de5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.85rem;
            margin-top: 5px;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .video-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.5);
            background: #000;
            aspect-ratio: 4/3;
        }

        #videoElement {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #canvasElement {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .video-container.mirror #videoElement,
        .video-container.mirror #canvasElement {
            transform: scaleX(-1);
        }

        .overlay-info {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
        }

        .status-badge {
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(10px);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ef4444;
            transition: background 0.3s;
        }

        .status-dot.active {
            background: #22c55e;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            50% { opacity: 0.8; box-shadow: 0 0 0 6px rgba(34, 197, 94, 0); }
        }

        .camera-switch-btn {
            position: absolute;
            bottom: 15px;
            right: 15px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 1.3rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            z-index: 10;
        }

        .camera-switch-btn:hover {
            background: rgba(0, 245, 212, 0.3);
            border-color: #00f5d4;
            transform: scale(1.1);
        }

        .camera-switch-btn:active {
            transform: scale(0.95);
        }

        .camera-switch-btn.switching {
            animation: spin 0.5s ease-in-out;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(180deg); }
        }

        .jump-flash {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4rem;
            font-weight: 800;
            color: #00f5d4;
            text-shadow: 0 0 30px rgba(0, 245, 212, 0.8);
            opacity: 0;
            pointer-events: none;
            z-index: 10;
        }

        .jump-flash.show {
            animation: jumpPop 0.4s ease-out;
        }

        @keyframes jumpPop {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(0.5); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
        }

        .calibration-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .calibration-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .calibration-text {
            font-size: 1.2rem;
            margin-bottom: 15px;
        }

        .calibration-progress {
            width: 200px;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
        }

        .calibration-bar {
            height: 100%;
            background: linear-gradient(90deg, #00f5d4, #00bbf9);
            width: 0%;
            transition: width 0.1s;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }

        .stat-card:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-2px);
        }

        .stat-card.primary {
            grid-column: span 2;
            background: linear-gradient(135deg, rgba(0, 245, 212, 0.15), rgba(155, 93, 229, 0.15));
            border-color: rgba(0, 245, 212, 0.3);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(90deg, #00f5d4, #00bbf9);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card.primary .stat-value {
            font-size: 3.5rem;
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.8rem;
            margin-top: 5px;
        }

        /* Voice Settings */
        .voice-settings {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 15px;
        }

        .voice-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .voice-title {
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .voice-toggle {
            position: relative;
            width: 50px;
            height: 26px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .voice-toggle.active {
            background: linear-gradient(90deg, #00f5d4, #00bbf9);
        }

        .voice-toggle::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .voice-toggle.active::after {
            transform: translateX(24px);
        }

        .voice-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .voice-option {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 12px;
        }

        .voice-option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .voice-option-label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .voice-option-value {
            font-size: 0.85rem;
            font-weight: 600;
            color: #00f5d4;
            min-width: 60px;
            text-align: right;
        }

        .voice-slider {
            width: 100%;
            -webkit-appearance: none;
            height: 4px;
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
        }

        .voice-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00f5d4, #00bbf9);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .voice-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .voice-option-desc {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.4);
            margin-top: 6px;
        }

        .voice-mode-btns {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .voice-mode-btn {
            flex: 1;
            min-width: 80px;
            padding: 8px 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .voice-mode-btn.active {
            background: linear-gradient(135deg, rgba(0, 245, 212, 0.2), rgba(0, 187, 249, 0.2));
            border-color: #00f5d4;
            color: #00f5d4;
        }

        .voice-mode-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Algorithm Parameters */
        .params-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 15px;
        }

        .params-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            cursor: pointer;
        }

        .params-title {
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .params-toggle-icon {
            transition: transform 0.3s;
        }

        .params-section.collapsed .params-toggle-icon {
            transform: rotate(-90deg);
        }

        .params-section.collapsed .params-grid {
            display: none;
        }

        .params-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .param-item {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 12px;
        }

        .param-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .param-label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .param-value {
            font-size: 0.85rem;
            font-weight: 600;
            color: #00f5d4;
            min-width: 50px;
            text-align: right;
        }

        .param-slider {
            width: 100%;
            -webkit-appearance: none;
            height: 4px;
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
        }

        .param-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00f5d4, #00bbf9);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .param-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .param-desc {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.4);
            margin-top: 6px;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 30px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(90deg, #00f5d4, #00bbf9);
            color: #0c0c1e;
        }

        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 245, 212, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        .btn-warning {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        /* Tips */
        .tips-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .tips-title {
            font-size: 0.9rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tips-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
        }

        .tip-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            font-size: 0.8rem;
        }

        .tip-icon {
            font-size: 1.2rem;
        }

        .tip-item strong {
            color: #00f5d4;
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(12, 12, 30, 0.98);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loader {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #00f5d4;
            border-radius: 50%;
            animation: spinLoader 1s linear infinite;
        }

        @keyframes spinLoader {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Permission Modal */
        .permission-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(12, 12, 30, 0.98);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            padding: 20px;
            text-align: center;
        }

        .permission-modal.hidden {
            display: none;
        }

        .permission-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .permission-modal h2 {
            font-size: 1.4rem;
            margin-bottom: 15px;
        }

        .permission-modal p {
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 25px;
            max-width: 400px;
            line-height: 1.5;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .stat-card.primary {
                grid-column: span 2;
            }

            .stat-card.primary .stat-value {
                font-size: 2.5rem;
            }

            .stat-value {
                font-size: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }

            h1 {
                font-size: 1.3rem;
            }

            .params-grid {
                grid-template-columns: 1fr;
            }

            .tips-list {
                grid-template-columns: 1fr;
            }

            .voice-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loader"></div>
        <p class="loading-text">æ­£åœ¨è¼‰å…¥ MediaPipe Pose æ¨¡å‹...</p>
    </div>

    <div class="permission-modal" id="permissionModal">
        <div class="permission-icon">ğŸ“·</div>
        <h2>éœ€è¦ç›¸æ©Ÿæ¬Šé™</h2>
        <p>æ­¤æ‡‰ç”¨ä½¿ç”¨ AI å§¿æ…‹åµæ¸¬ä¾†è¿½è¹¤æ‚¨çš„è·³ç¹©å‹•ä½œã€‚æ‰€æœ‰è™•ç†éƒ½åœ¨æ‚¨çš„è£ç½®ä¸Šå®Œæˆï¼Œå½±åƒä¸æœƒè¢«ä¸Šå‚³ã€‚</p>
        <button class="btn btn-primary" id="requestPermission">
            <span>ğŸ“·</span>
            å…è¨±ä½¿ç”¨ç›¸æ©Ÿ
        </button>
    </div>

    <div class="container">
        <header>
            <h1>ğŸ¯ é«˜ç²¾åº¦ AI è·³ç¹©è¨ˆæ•¸å™¨</h1>
            <p class="subtitle">éª¨ç›†è¿½è¹¤ + EMAå¹³æ»‘ + æ³¢å³°æª¢æ¸¬ + å‹•æ…‹é–¾å€¼</p>
        </header>

        <main class="main-content">
            <div class="video-container mirror" id="videoContainer">
                <video id="videoElement" playsinline=""></video>
                <canvas id="canvasElement"></canvas>
                
                <div class="overlay-info">
                    <div class="status-badge">
                        <div class="status-dot" id="statusDot"></div>
                        <span id="statusText">ç­‰å¾…å•Ÿå‹•</span>
                    </div>
                    <div class="status-badge">
                        FPS: <span id="fpsValue">--</span>
                    </div>
                </div>

                <div class="jump-flash" id="jumpFlash">+1</div>

                <button class="camera-switch-btn" id="cameraSwitchBtn" title="åˆ‡æ›å‰å¾Œé¡é ­">
                    ğŸ”„
                </button>

                <div class="calibration-overlay" id="calibrationOverlay">
                    <div class="calibration-text">ğŸ“ æ ¡æ­£ä¸­ï¼Œè«‹ç«™ç«‹ä¸å‹•...</div>
                    <div class="calibration-progress">
                        <div class="calibration-bar" id="calibrationBar"></div>
                    </div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card primary">
                    <div class="stat-value" id="jumpCount">0</div>
                    <div class="stat-label">è·³ç¹©æ¬¡æ•¸</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="jumpRate">0</div>
                    <div class="stat-label">æ¬¡/åˆ†é˜</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="duration">0:00</div>
                    <div class="stat-label">é‹å‹•æ™‚é–“</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="calories">0</div>
                    <div class="stat-label">æ¶ˆè€—å¡è·¯é‡Œ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="accuracy">--%</div>
                    <div class="stat-label">åµæ¸¬ä¿¡å¿ƒåº¦</div>
                </div>
            </div>

            <!-- Voice Settings Section -->
            <div class="voice-settings">
                <div class="voice-header">
                    <div class="voice-title">
                        <span>ğŸ”Š</span>
                        èªéŸ³æç¤ºè¨­å®š
                    </div>
                    <div class="voice-toggle" id="voiceToggle"></div>
                </div>
                <div class="voice-options" id="voiceOptions">
                    <div class="voice-option">
                        <div class="voice-option-header">
                            <span class="voice-option-label">æç¤ºæ¨¡å¼</span>
                        </div>
                        <div class="voice-mode-btns">
                            <button class="voice-mode-btn active" data-mode="interval">æ¯ N ä¸‹</button>
                            <button class="voice-mode-btn" data-mode="milestone">é‡Œç¨‹ç¢‘</button>
                        </div>
                        <div class="voice-option-desc">ã€Œæ¯Nä¸‹ã€å›ºå®šé–“éš”æç¤ºï¼›ã€Œé‡Œç¨‹ç¢‘ã€åœ¨ç‰¹å®šæ•¸å­—æç¤º</div>
                    </div>
                    <div class="voice-option" id="intervalOption">
                        <div class="voice-option-header">
                            <span class="voice-option-label">æç¤ºé–“éš”</span>
                            <span class="voice-option-value" id="intervalValue">æ¯ 10 ä¸‹</span>
                        </div>
                        <input type="range" class="voice-slider" id="intervalSlider" min="5" max="50" step="5" value="10">
                        <div class="voice-option-desc">æ¯è·³å¹¾ä¸‹å ±ä¸€æ¬¡æ•¸ï¼ˆå»ºè­° 10-20 ä¸‹é¿å…å¤ªé »ç¹ï¼‰</div>
                    </div>
                    <div class="voice-option">
                        <div class="voice-option-header">
                            <span class="voice-option-label">èªéŸ³é€Ÿåº¦</span>
                            <span class="voice-option-value" id="rateValue">1.0x</span>
                        </div>
                        <input type="range" class="voice-slider" id="rateSlider" min="8" max="15" value="10">
                        <div class="voice-option-desc">èª¿æ•´èªéŸ³æ’­å ±é€Ÿåº¦</div>
                    </div>
                    <div class="voice-option">
                        <div class="voice-option-header">
                            <span class="voice-option-label">æœ€å°æ’­å ±é–“éš”</span>
                            <span class="voice-option-value" id="minGapValue">2 ç§’</span>
                        </div>
                        <input type="range" class="voice-slider" id="minGapSlider" min="1" max="5" value="2">
                        <div class="voice-option-desc">ç¢ºä¿å…©æ¬¡èªéŸ³ä¹‹é–“çš„æœ€å°é–“éš”ï¼Œé¿å…è½ä¸æ¸…æ¥š</div>
                    </div>
                </div>
            </div>

            <div class="params-section collapsed" id="paramsSection">
                <div class="params-header" id="paramsHeader">
                    <div class="params-title">
                        <span>âš™ï¸</span>
                        æ¼”ç®—æ³•åƒæ•¸èª¿æ•´
                    </div>
                    <span class="params-toggle-icon">â–¼</span>
                </div>
                <div class="params-grid">
                    <div class="param-item">
                        <div class="param-header">
                            <span class="param-label">EMA å¹³æ»‘ä¿‚æ•¸ (Î±)</span>
                            <span class="param-value" id="alphaValue">0.6</span>
                        </div>
                        <input type="range" class="param-slider" id="alphaSlider" min="30" max="90" value="60">
                        <div class="param-desc">è¼ƒä½ = æ›´å¹³æ»‘ä½†å»¶é²è¼ƒé«˜ | è¼ƒé«˜ = åæ‡‰å¿«ä½†é›œè¨Šå¤š</div>
                    </div>
                    <div class="param-item">
                        <div class="param-header">
                            <span class="param-label">å†·å»æ™‚é–“ (ms)</span>
                            <span class="param-value" id="cooldownValue">250</span>
                        </div>
                        <input type="range" class="param-slider" id="cooldownSlider" min="150" max="500" value="250">
                        <div class="param-desc">é˜²æ­¢ä¸€æ¬¡è·³èºè¢«ç®—å¤šæ¬¡çš„æœ€å°é–“éš”</div>
                    </div>
                    <div class="param-item">
                        <div class="param-header">
                            <span class="param-label">è·³èºé–¾å€¼ (å°è…¿é•·åº¦ %)</span>
                            <span class="param-value" id="thresholdValue">15%</span>
                        </div>
                        <input type="range" class="param-slider" id="thresholdSlider" min="5" max="40" value="15">
                        <div class="param-desc">å‹•æ…‹é–¾å€¼ï¼šè·³èºé«˜åº¦éœ€è¶…éå°è…¿é•·åº¦çš„æ­¤ç™¾åˆ†æ¯”</div>
                    </div>
                    <div class="param-item">
                        <div class="param-header">
                            <span class="param-label">æ ¡æ­£å¹€æ•¸</span>
                            <span class="param-value" id="calibrationValue">30</span>
                        </div>
                        <input type="range" class="param-slider" id="calibrationSlider" min="15" max="60" value="30">
                        <div class="param-desc">ç”¨æ–¼å»ºç«‹åŸºæº–ç·šçš„å¹€æ•¸ï¼ˆè¶Šå¤šè¶Šç©©å®šï¼‰</div>
                    </div>
                </div>
            </div>

            <div class="controls">
                <button class="btn btn-primary" id="startBtn">
                    <span>â–¶ï¸</span>
                    é–‹å§‹è¨ˆæ•¸
                </button>
                <button class="btn btn-secondary" id="pauseBtn" style="display: none;">
                    <span>â¸ï¸</span>
                    æš«åœ
                </button>
                <button class="btn btn-warning" id="recalibrateBtn" style="display: none;">
                    <span>ğŸ“</span>
                    é‡æ–°æ ¡æ­£
                </button>
                <button class="btn btn-danger" id="resetBtn">
                    <span>ğŸ”„</span>
                    é‡ç½®
                </button>
            </div>

            <section class="tips-section">
                <h3 class="tips-title">
                    <span>ğŸ’¡</span>
                    æ‹æ”å»ºè­°ï¼ˆæœ€å¤§åŒ–æº–ç¢ºåº¦ï¼‰
                </h3>
                <div class="tips-list">
                    <div class="tip-item">
                        <span class="tip-icon">ğŸ“</span>
                        <span><strong>æ­£é¢æˆ–å´é¢ 45Â°</strong> æ‹æ”ï¼Œç¢ºä¿éª¨ç›†æ¸…æ™°å¯è¦‹</span>
                    </div>
                    <div class="tip-item">
                        <span class="tip-icon">ğŸ“</span>
                        <span>è·é›¢ <strong>2-3 å…¬å°º</strong>ï¼Œç¢ºä¿å…¨èº«å…¥é¡ä¸¦ç•™ä¸Šæ–¹ç©ºé–“</span>
                    </div>
                    <div class="tip-item">
                        <span class="tip-icon">ğŸ’¡</span>
                        <span><strong>å……è¶³å…‰ç·š</strong>ï¼Œé¿å…é€†å…‰æˆ–é™°å½±é®æ“‹èº«é«”</span>
                    </div>
                    <div class="tip-item">
                        <span class="tip-icon">ğŸ‘•</span>
                        <span>ç©¿è‘—<strong>åˆèº«è¡£ç‰©</strong>ï¼Œèˆ‡èƒŒæ™¯é¡è‰²å°æ¯”æ˜é¡¯</span>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // ========== DOM Elements ==========
        const videoElement = document.getElementById('videoElement');
        const canvasElement = document.getElementById('canvasElement');
        const canvasCtx = canvasElement.getContext('2d');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const permissionModal = document.getElementById('permissionModal');
        const calibrationOverlay = document.getElementById('calibrationOverlay');
        const calibrationBar = document.getElementById('calibrationBar');
        const jumpFlash = document.getElementById('jumpFlash');
        const videoContainer = document.getElementById('videoContainer');
        const cameraSwitchBtn = document.getElementById('cameraSwitchBtn');

        // ========== Voice Announcement System ==========
        class VoiceAnnouncer {
            constructor() {
                this.enabled = false;
                this.mode = 'interval';
                this.interval = 10;
                this.rate = 1.0;
                this.minGap = 2000;
                this.lastAnnouncedCount = 0;
                this.lastAnnouncementTime = 0;
                this.synth = window.speechSynthesis;
                this.voice = null;
                this.milestones = [10, 20, 30, 50, 75, 100, 150, 200, 250, 300, 400, 500, 750, 1000];
                
                this.initVoice();
            }

            initVoice() {
                const loadVoices = () => {
                    const voices = this.synth.getVoices();
                    this.voice = voices.find(v => v.lang.includes('zh')) || 
                                 voices.find(v => v.lang.includes('TW')) ||
                                 voices.find(v => v.lang.includes('CN')) ||
                                 voices[0];
                };
                
                loadVoices();
                if (speechSynthesis.onvoiceschanged !== undefined) {
                    speechSynthesis.onvoiceschanged = loadVoices;
                }
            }

            setEnabled(enabled) {
                this.enabled = enabled;
            }

            setMode(mode) {
                this.mode = mode;
            }

            setInterval(interval) {
                this.interval = interval;
            }

            setRate(rate) {
                this.rate = rate;
            }

            setMinGap(gapMs) {
                this.minGap = gapMs;
            }

            shouldAnnounce(count) {
                if (!this.enabled || count === 0) return false;
                if (count === this.lastAnnouncedCount) return false;
                
                const now = Date.now();
                if (now - this.lastAnnouncementTime < this.minGap) return false;

                if (this.mode === 'interval') {
                    return count % this.interval === 0;
                } else {
                    return this.milestones.includes(count);
                }
            }

            announce(count) {
                if (!this.shouldAnnounce(count)) return;

                this.synth.cancel();

                const text = `${count}`;
                const utterance = new SpeechSynthesisUtterance(text);
                
                if (this.voice) {
                    utterance.voice = this.voice;
                }
                utterance.rate = this.rate;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;

                this.synth.speak(utterance);
                this.lastAnnouncedCount = count;
                this.lastAnnouncementTime = Date.now();
            }

            reset() {
                this.lastAnnouncedCount = 0;
                this.lastAnnouncementTime = 0;
                this.synth.cancel();
            }
        }

        // ========== Camera Manager ==========
        class CameraManager {
            constructor() {
                this.currentFacingMode = 'user';
                this.stream = null;
                this.hasMultipleCameras = false;
                this.checkCameraAvailability();
            }

            async checkCameraAvailability() {
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const videoDevices = devices.filter(d => d.kind === 'videoinput');
                    this.hasMultipleCameras = videoDevices.length > 1;
                    cameraSwitchBtn.style.display = this.hasMultipleCameras ? 'flex' : 'none';
                } catch (e) {
                    console.log('Could not enumerate devices:', e);
                }
            }

            async startCamera(facingMode = 'user') {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                }

                try {
                    this.stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: facingMode,
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        }
                    });

                    videoElement.srcObject = this.stream;
                    await videoElement.play();

                    canvasElement.width = videoElement.videoWidth || 640;
                    canvasElement.height = videoElement.videoHeight || 480;

                    this.currentFacingMode = facingMode;

                    if (facingMode === 'user') {
                        videoContainer.classList.add('mirror');
                    } else {
                        videoContainer.classList.remove('mirror');
                    }

                    return true;
                } catch (error) {
                    console.error('Camera error:', error);
                    return false;
                }
            }

            async switchCamera() {
                const newFacingMode = this.currentFacingMode === 'user' ? 'environment' : 'user';
                
                cameraSwitchBtn.classList.add('switching');
                setTimeout(() => cameraSwitchBtn.classList.remove('switching'), 500);

                const success = await this.startCamera(newFacingMode);
                
                if (success && jumpCounter.isCalibrated) {
                    jumpCounter.recalibrate();
                }
                
                return success;
            }

            getFacingMode() {
                return this.currentFacingMode;
            }
        }

        // ========== Jump Counter Class ==========
        class RobustJumpCounter {
            constructor() {
                this.reset();
                this.alpha = 0.6;
                this.cooldown = 250;
                this.thresholdPercent = 0.15;
                this.calibrationFrames = 30;
            }

            reset() {
                this.count = 0;
                this.smoothVal = null;
                this.prevVal = null;
                this.prevPrevVal = null;
                
                this.isCalibrated = false;
                this.calibrationData = [];
                this.groundLevel = 0;
                this.legLength = 0;
                
                this.state = 'GROUND';
                this.lastJumpTime = 0;
                this.peakValue = 0;
                
                this.jumpTimestamps = [];
                this.confidenceSum = 0;
                this.confidenceCount = 0;
            }

            setParams(alpha, cooldown, thresholdPercent, calibrationFrames) {
                this.alpha = alpha;
                this.cooldown = cooldown;
                this.thresholdPercent = thresholdPercent;
                this.calibrationFrames = calibrationFrames;
            }

            calculateLegLength(landmarks) {
                const leftKnee = landmarks[25];
                const rightKnee = landmarks[26];
                const leftAnkle = landmarks[27];
                const rightAnkle = landmarks[28];

                const leftLeg = Math.hypot(
                    leftKnee.x - leftAnkle.x,
                    leftKnee.y - leftAnkle.y
                );
                const rightLeg = Math.hypot(
                    rightKnee.x - rightAnkle.x,
                    rightKnee.y - rightAnkle.y
                );

                return (leftLeg + rightLeg) / 2;
            }

            process(landmarks, timestamp) {
                const leftHipY = landmarks[23].y;
                const rightHipY = landmarks[24].y;
                const leftHipVis = landmarks[23].visibility;
                const rightHipVis = landmarks[24].visibility;

                const avgVisibility = (leftHipVis + rightHipVis) / 2;
                if (avgVisibility < 0.5) {
                    return { count: this.count, state: 'NO_DETECTION', confidence: 0 };
                }

                this.confidenceSum += avgVisibility;
                this.confidenceCount++;

                const rawVal = 1.0 - (leftHipY + rightHipY) / 2;

                if (this.smoothVal === null) {
                    this.smoothVal = rawVal;
                }
                this.smoothVal = (this.alpha * rawVal) + ((1 - this.alpha) * this.smoothVal);

                if (!this.isCalibrated) {
                    this.calibrationData.push(this.smoothVal);
                    this.legLength = this.calculateLegLength(landmarks);

                    if (this.calibrationData.length >= this.calibrationFrames) {
                        this.groundLevel = this.calibrationData.reduce((a, b) => a + b, 0) 
                                         / this.calibrationData.length;
                        this.isCalibrated = true;
                    }

                    return { 
                        count: 0, 
                        state: 'CALIBRATING', 
                        progress: this.calibrationData.length / this.calibrationFrames,
                        confidence: avgVisibility
                    };
                }

                const amplitude = this.smoothVal - this.groundLevel;
                const jumpThreshold = this.legLength * this.thresholdPercent;

                let jumped = false;
                const timeSinceLastJump = timestamp - this.lastJumpTime;

                if (this.prevVal !== null && this.prevPrevVal !== null) {
                    const isRising = this.prevVal > this.prevPrevVal;
                    const isFalling = this.smoothVal < this.prevVal;
                    const isAboveThreshold = amplitude > jumpThreshold;

                    switch (this.state) {
                        case 'GROUND':
                            if (isRising && isAboveThreshold) {
                                this.state = 'RISING';
                                this.peakValue = this.smoothVal;
                            }
                            break;

                        case 'RISING':
                            if (this.smoothVal > this.peakValue) {
                                this.peakValue = this.smoothVal;
                            }
                            if (isFalling) {
                                this.state = 'PEAK';
                            }
                            break;

                        case 'PEAK':
                            if (timeSinceLastJump > this.cooldown) {
                                this.count++;
                                this.lastJumpTime = timestamp;
                                this.jumpTimestamps.push(timestamp);
                                jumped = true;
                            }
                            this.state = 'FALLING';
                            break;

                        case 'FALLING':
                            if (amplitude < jumpThreshold * 0.3) {
                                this.state = 'GROUND';
                                this.groundLevel = this.groundLevel * 0.98 + this.smoothVal * 0.02;
                            }
                            break;
                    }
                }

                this.prevPrevVal = this.prevVal;
                this.prevVal = this.smoothVal;

                const oneMinuteAgo = timestamp - 60000;
                this.jumpTimestamps = this.jumpTimestamps.filter(t => t > oneMinuteAgo);

                return {
                    count: this.count,
                    state: this.state,
                    jumped: jumped,
                    confidence: avgVisibility,
                    jumpRate: this.jumpTimestamps.length
                };
            }

            getAverageConfidence() {
                if (this.confidenceCount === 0) return 0;
                return this.confidenceSum / this.confidenceCount;
            }

            recalibrate() {
                this.isCalibrated = false;
                this.calibrationData = [];
            }
        }

        // ========== App State ==========
        let pose = null;
        let camera = null;
        let cameraManager = new CameraManager();
        let jumpCounter = new RobustJumpCounter();
        let voiceAnnouncer = new VoiceAnnouncer();
        let isRunning = false;
        let isPaused = false;
        let startTime = null;
        let pausedDuration = 0;
        let lastPauseTime = null;
        let frameCount = 0;
        let lastFpsUpdate = Date.now();
        let fps = 0;
        let durationInterval = null;

        // ========== Initialize MediaPipe Pose ==========
        function initPose() {
            pose = new Pose({
                locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
                }
            });

            pose.setOptions({
                modelComplexity: 1,
                smoothLandmarks: true,
                enableSegmentation: false,
                minDetectionConfidence: 0.6,
                minTrackingConfidence: 0.6
            });

            pose.onResults(onResults);
        }

        // ========== Process Pose Results ==========
        function onResults(results) {
            frameCount++;
            const now = Date.now();
            if (now - lastFpsUpdate >= 1000) {
                fps = frameCount;
                frameCount = 0;
                lastFpsUpdate = now;
                document.getElementById('fpsValue').textContent = fps;
            }

            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

            if (results.poseLandmarks) {
                drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {
                    color: 'rgba(0, 245, 212, 0.5)',
                    lineWidth: 2
                });
                
                const keyPoints = [23, 24, 25, 26, 27, 28];
                keyPoints.forEach(idx => {
                    const point = results.poseLandmarks[idx];
                    canvasCtx.beginPath();
                    canvasCtx.arc(
                        point.x * canvasElement.width,
                        point.y * canvasElement.height,
                        6, 0, Math.PI * 2
                    );
                    canvasCtx.fillStyle = idx <= 24 ? '#00f5d4' : '#9b5de5';
                    canvasCtx.fill();
                });

                if (isRunning && !isPaused) {
                    const result = jumpCounter.process(results.poseLandmarks, now);
                    
                    if (result.state === 'CALIBRATING') {
                        calibrationOverlay.classList.add('show');
                        calibrationBar.style.width = (result.progress * 100) + '%';
                        document.getElementById('statusDot').classList.remove('active');
                        document.getElementById('statusText').textContent = 'æ ¡æ­£ä¸­...';
                    } else {
                        calibrationOverlay.classList.remove('show');
                        document.getElementById('statusDot').classList.add('active');
                        document.getElementById('statusText').textContent = 'åµæ¸¬ä¸­';
                        
                        if (result.jumped) {
                            showJumpFlash();
                            voiceAnnouncer.announce(result.count);
                        }
                        
                        updateStats(result);
                    }
                }
                
            } else {
                document.getElementById('statusDot').classList.remove('active');
                document.getElementById('statusText').textContent = 'æœªåµæ¸¬åˆ°äººé«”';
            }
        }

        // ========== UI Updates ==========
        function showJumpFlash() {
            jumpFlash.classList.remove('show');
            void jumpFlash.offsetWidth;
            jumpFlash.classList.add('show');
        }

        function updateStats(result) {
            document.getElementById('jumpCount').textContent = result.count;
            document.getElementById('jumpRate').textContent = result.jumpRate;
            document.getElementById('accuracy').textContent = 
                Math.round(jumpCounter.getAverageConfidence() * 100) + '%';
            document.getElementById('calories').textContent = Math.round(result.count * 0.1);
        }

        function updateDuration() {
            if (!startTime || isPaused) return;
            
            const elapsed = Date.now() - startTime - pausedDuration;
            const seconds = Math.floor(elapsed / 1000);
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            document.getElementById('duration').textContent = 
                `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        // ========== Camera Setup ==========
        async function startCamera() {
            try {
                const success = await cameraManager.startCamera('user');
                
                if (success) {
                    permissionModal.classList.add('hidden');

                    camera = new Camera(videoElement, {
                        onFrame: async () => {
                            await pose.send({ image: videoElement });
                        },
                        width: 640,
                        height: 480
                    });
                    camera.start();

                    loadingOverlay.classList.add('hidden');
                } else {
                    throw new Error('Failed to start camera');
                }
            } catch (error) {
                console.error('Camera error:', error);
                alert('ç„¡æ³•å­˜å–ç›¸æ©Ÿï¼Œè«‹ç¢ºèªå·²æˆäºˆæ¬Šé™ä¸¦é‡æ–°æ•´ç†é é¢ã€‚');
            }
        }

        // ========== Setup Voice Controls ==========
        function setupVoiceControls() {
            const voiceToggle = document.getElementById('voiceToggle');
            const intervalSlider = document.getElementById('intervalSlider');
            const rateSlider = document.getElementById('rateSlider');
            const minGapSlider = document.getElementById('minGapSlider');
            const modeBtns = document.querySelectorAll('.voice-mode-btn');
            const intervalOption = document.getElementById('intervalOption');

            voiceToggle.addEventListener('click', () => {
                voiceToggle.classList.toggle('active');
                voiceAnnouncer.setEnabled(voiceToggle.classList.contains('active'));
            });

            modeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    modeBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const mode = btn.dataset.mode;
                    voiceAnnouncer.setMode(mode);
                    intervalOption.style.display = mode === 'interval' ? 'block' : 'none';
                });
            });

            intervalSlider.addEventListener('input', (e) => {
                const val = parseInt(e.target.value);
                document.getElementById('intervalValue').textContent = `æ¯ ${val} ä¸‹`;
                voiceAnnouncer.setInterval(val);
            });

            rateSlider.addEventListener('input', (e) => {
                const val = e.target.value / 10;
                document.getElementById('rateValue').textContent = `${val.toFixed(1)}x`;
                voiceAnnouncer.setRate(val);
            });

            minGapSlider.addEventListener('input', (e) => {
                const val = parseInt(e.target.value);
                document.getElementById('minGapValue').textContent = `${val} ç§’`;
                voiceAnnouncer.setMinGap(val * 1000);
            });
        }

        // ========== Parameter Sliders ==========
        function setupSliders() {
            const alphaSlider = document.getElementById('alphaSlider');
            const cooldownSlider = document.getElementById('cooldownSlider');
            const thresholdSlider = document.getElementById('thresholdSlider');
            const calibrationSlider = document.getElementById('calibrationSlider');

            alphaSlider.addEventListener('input', (e) => {
                const val = e.target.value / 100;
                document.getElementById('alphaValue').textContent = val.toFixed(2);
                jumpCounter.alpha = val;
            });

            cooldownSlider.addEventListener('input', (e) => {
                const val = parseInt(e.target.value);
                document.getElementById('cooldownValue').textContent = val;
                jumpCounter.cooldown = val;
            });

            thresholdSlider.addEventListener('input', (e) => {
                const val = parseInt(e.target.value);
                document.getElementById('thresholdValue').textContent = val + '%';
                jumpCounter.thresholdPercent = val / 100;
            });

            calibrationSlider.addEventListener('input', (e) => {
                const val = parseInt(e.target.value);
                document.getElementById('calibrationValue').textContent = val;
                jumpCounter.calibrationFrames = val;
            });
        }

        // ========== Event Listeners ==========
        document.getElementById('requestPermission').addEventListener('click', startCamera);

        cameraSwitchBtn.addEventListener('click', async () => {
            await cameraManager.switchCamera();
        });

        document.getElementById('paramsHeader').addEventListener('click', () => {
            document.getElementById('paramsSection').classList.toggle('collapsed');
        });

        document.getElementById('startBtn').addEventListener('click', () => {
            if (!isRunning) {
                isRunning = true;
                isPaused = false;
                startTime = Date.now();
                pausedDuration = 0;
                jumpCounter.reset();
                voiceAnnouncer.reset();
                
                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('pauseBtn').style.display = 'flex';
                document.getElementById('recalibrateBtn').style.display = 'flex';
                
                if (durationInterval) clearInterval(durationInterval);
                durationInterval = setInterval(updateDuration, 1000);
            }
        });

        document.getElementById('pauseBtn').addEventListener('click', () => {
            isPaused = !isPaused;
            const btn = document.getElementById('pauseBtn');
            if (isPaused) {
                lastPauseTime = Date.now();
                btn.innerHTML = '<span>â–¶ï¸</span>ç¹¼çºŒ';
                document.getElementById('statusText').textContent = 'å·²æš«åœ';
            } else {
                pausedDuration += Date.now() - lastPauseTime;
                btn.innerHTML = '<span>â¸ï¸</span>æš«åœ';
            }
        });

        document.getElementById('recalibrateBtn').addEventListener('click', () => {
            jumpCounter.recalibrate();
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            isRunning = false;
            isPaused = false;
            startTime = null;
            pausedDuration = 0;
            jumpCounter.reset();
            voiceAnnouncer.reset();

            if (durationInterval) {
                clearInterval(durationInterval);
                durationInterval = null;
            }

            document.getElementById('jumpCount').textContent = '0';
            document.getElementById('jumpRate').textContent = '0';
            document.getElementById('duration').textContent = '0:00';
            document.getElementById('calories').textContent = '0';
            document.getElementById('accuracy').textContent = '--%';

            document.getElementById('startBtn').style.display = 'flex';
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('recalibrateBtn').style.display = 'none';
            document.getElementById('pauseBtn').innerHTML = '<span>â¸ï¸</span>æš«åœ';
            
            document.getElementById('statusDot').classList.remove('active');
            document.getElementById('statusText').textContent = 'ç­‰å¾…å•Ÿå‹•';
        });

        // ========== Initialize ==========
        initPose();
        setupSliders();
        setupVoiceControls();

        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                stream.getTracks().forEach(track => track.stop());
                startCamera();
            })
            .catch(() => {
                loadingOverlay.classList.add('hidden');
                permissionModal.classList.remove('hidden');
            });
    </script>


</body></html>